<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marks Manager - LinkedList Based</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="/src/data_structures/selection_sort.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .marks-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        .current-student {
            border: 3px solid #3B82F6;
            background: #EBF8FF;
        }
        .completed-student {
            background: #F0FDF4;
            border-left: 4px solid #10B981;
        }
        .pending-student {
            background: #FEF3C7;
            border-left: 4px solid #F59E0B;
        }
        .mark-input {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Marks Manager</h1>
                    <p class="mt-1 text-sm text-gray-500">LinkedList-based marks entry system</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button 
                        onclick="goHome()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                        <span>Home</span>
                    </button>
                    <button 
                        onclick="goBack()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200 flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span>Back to Summary</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Parameter Display Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 fade-in">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Session Information</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="text-sm text-blue-600 font-medium">Year</div>
                    <div class="text-lg font-bold text-blue-800" id="displayYear">-</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <div class="text-sm text-green-600 font-medium">Class Name</div>
                    <div class="text-lg font-bold text-green-800" id="displayClassName">-</div>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm text-purple-600 font-medium">Test Number</div>
                    <div class="text-lg font-bold text-purple-800" id="displayTestNumber">-</div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <div class="text-sm text-orange-600 font-medium">Subject</div>
                    <div class="text-lg font-bold text-orange-800" id="displaySubject">-</div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 fade-in" id="progressSection">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Progress</h3>
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Students Completed</span>
                        <span id="progressText">0 / 0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="progress-bar bg-blue-600 h-2 rounded-full" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="text-2xl font-bold text-blue-600" id="progressPercentage">0%</div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            <p class="mt-2 text-gray-600">Loading students data...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="text-center py-12 hidden">
            <div class="text-red-500 mb-4">
                <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900">Error loading students</h3>
            <p class="mt-1 text-gray-500" id="errorMessage">Something went wrong. Please try again.</p>
            <button 
                onclick="loadStudentsData()"
                class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200"
            >
                Retry
            </button>
        </div>

        <!-- Mark Entry Section -->
        <div id="markEntrySection" class="bg-white rounded-lg shadow-md p-6 mb-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Enter Student Marks</h3>
                <div class="text-sm text-gray-500">
                    <span>Current: </span>
                    <span id="currentPosition" class="font-medium">1</span>
                    <span> of </span>
                    <span id="totalStudents" class="font-medium">0</span>
                </div>
            </div>

            <!-- Current Student Card -->
            <div class="current-student rounded-lg p-6 mb-6">
                <div class="text-center">
                    <div class="text-sm text-gray-600 mb-2">Student Index</div>
                    <div class="text-4xl font-bold text-blue-600 mb-4" id="currentStudentIndex">-</div>
                    
                    <div class="text-sm text-gray-600 mb-2">Enter Mark (0-100)</div>
                    <input 
                        type="number" 
                        id="markInput" 
                        class="mark-input w-32 h-16 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        min="0" 
                        max="100" 
                        placeholder="0"
                        onkeypress="handleMarkInputKeypress(event)"
                    >
                    
                    <div class="mt-4 space-x-4">
                        <button 
                            onclick="previousStudent()"
                            id="prevButton"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled
                        >
                            Previous
                        </button>
                        <button 
                            onclick="nextStudent()"
                            id="nextButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition duration-200"
                        >
                            Next
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation Helper -->
            <div class="text-center text-sm text-gray-500">
                <p>Use the Next button or press Enter to move to the next student</p>
                <p>You can go back to edit previous entries using the Previous button</p>
            </div>
        </div>

        <!-- LinkedList Display Table -->
        <div id="marksTableContainer" class="bg-white rounded-lg shadow-md overflow-hidden hidden">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Students LinkedList View</h3>
                        <p class="text-sm text-gray-600">Current state of the LinkedList with student marks</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Sort:</span>
                        <button 
                            onclick="sortLinkedListTable(true)"
                            class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-200"
                            title="Sort by Mark - Ascending"
                        >
                            <i class="fas fa-sort-amount-down mr-1"></i>Low to High
                        </button>
                        <button 
                            onclick="sortLinkedListTable(false)"
                            class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-200"
                            title="Sort by Mark - Descending"
                        >
                            <i class="fas fa-sort-amount-up mr-1"></i>High to Low
                        </button>
                        <button 
                            onclick="resetLinkedListOrder()"
                            class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm font-medium transition duration-200"
                            title="Reset to Original Order"
                        >
                            <i class="fas fa-undo mr-1"></i>Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="marks-table">
                <table class="min-w-full">
                    <thead class="sticky-header bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-900">Index</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-900 cursor-pointer hover:bg-gray-100 transition-colors duration-200" 
                                onclick="toggleMarkSort()" 
                                onkeypress="if(event.key==='Enter') toggleMarkSort()"
                                tabindex="0"
                                title="Click to sort by marks">
                                Mark
                                <span class="sort-indicator ml-1 text-gray-400" id="markSortIndicator">
                                    <i class="fas fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-900">Grade</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-900">Status</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-900">Action</th>
                        </tr>
                    </thead>
                    <tbody id="marksTableBody">
                        <!-- Marks data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Save Section -->
        <div id="saveSection" class="bg-white rounded-lg shadow-md p-6 mt-8 hidden">
            <div class="text-center">
                <div class="text-green-600 mb-4">
                    <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">All Students Completed!</h3>
                <p class="text-gray-600 mb-6">You have entered marks for all students. Click save to store the data in the database.</p>
                
                <div class="space-x-4">
                    <button 
                        onclick="saveAllMarks()"
                        id="saveButton"
                        class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-medium transition duration-200 text-lg"
                    >
                        Save All Marks to Database
                    </button>
                    <button 
                        onclick="reviewMarks()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition duration-200"
                    >
                        Review & Edit
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- LinkedList Implementation Script -->
    <script>
        // Import LinkedList class (simulated)
        class Node {
            constructor(data) {
                this.data = data;
                this.next = null;
            }
        }

        class DLinkedList {
            constructor() {
                this.head = null;
                this.size = 0;
            }

            add(data) {
                const newNode = new Node(data);
                
                if (!this.head) {
                    this.head = newNode;
                } else {
                    let current = this.head;
                    while (current.next) {
                        current = current.next;
                    }
                    current.next = newNode;
                }
                this.size++;
                return true;
            }

            get(index) {
                if (index < 0 || index >= this.size) {
                    return null;
                }

                let current = this.head;
                for (let i = 0; i < index; i++) {
                    current = current.next;
                }

                return current.data;
            }

            set(index, data) {
                if (index < 0 || index >= this.size) {
                    return false;
                }

                let current = this.head;
                for (let i = 0; i < index; i++) {
                    current = current.next;
                }

                current.data = data;
                return true;
            }

            getSize() {
                return this.size;
            }

            toArray() {
                const array = [];
                let current = this.head;
                while (current) {
                    array.push(current.data);
                    current = current.next;
                }
                return array;
            }
        }

        // Global variables
        let sessionParams = {
            year: null,
            className: null,
            testNumber: null,
            subject: null
        };
        
        let studentsLinkedList = new DLinkedList();
        let currentStudentIndex = 0;
        let totalStudents = 0;
        let allMarksEntered = false;

        // Parse URL parameters
        function parseUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            sessionParams.year = urlParams.get('year');
            sessionParams.className = urlParams.get('className');
            sessionParams.testNumber = urlParams.get('testNumber');
            sessionParams.subject = urlParams.get('subject');
            
            updateParameterDisplay();
            console.log('Parsed URL Parameters:', sessionParams);
        }

        // Update parameter display
        function updateParameterDisplay() {
            document.getElementById('displayYear').textContent = sessionParams.year || '-';
            document.getElementById('displayClassName').textContent = sessionParams.className || '-';
            document.getElementById('displayTestNumber').textContent = sessionParams.testNumber || '-';
            document.getElementById('displaySubject').textContent = sessionParams.subject || '-';
        }

        // Validate parameters
        function validateParameters() {
            const required = ['year', 'className', 'testNumber', 'subject'];
            const missing = required.filter(param => !sessionParams[param]);
            
            if (missing.length > 0) {
                showError(`Missing required parameters: ${missing.join(', ')}`);
                return false;
            }
            
            return true;
        }

        // Load students data and populate LinkedList
        async function loadStudentsData() {
            if (!validateParameters()) {
                return;
            }
            
            showLoadingState();
            
            try {
                const params = new URLSearchParams(sessionParams);
                const response = await fetch(`/api/marks/students?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    populateLinkedList(result.students);
                    totalStudents = result.students.length;
                    showMarkEntrySection();
                    updateProgress();
                } else {
                    showError(result.error || 'Failed to load students data');
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Network error. Please check your connection.');
            }
        }

        // Populate LinkedList with students data
        function populateLinkedList(studentsData) {
            studentsLinkedList = new DLinkedList();
            
            studentsData.forEach(student => {
                studentsLinkedList.add({
                    index: student.index,
                    mark: student.mark,
                    isCompleted: student.mark > 0 || student.isInitialized
                });
            });

            console.log(`LinkedList populated with ${studentsLinkedList.getSize()} students`);
            
            // Find the first incomplete student
            currentStudentIndex = 0;
            for (let i = 0; i < studentsLinkedList.getSize(); i++) {
                const student = studentsLinkedList.get(i);
                if (!student.isCompleted) {
                    currentStudentIndex = i;
                    break;
                }
            }
            
            updateCurrentStudentDisplay();
            updateLinkedListTable();
        }

        // Update current student display
        function updateCurrentStudentDisplay() {
            const currentStudent = studentsLinkedList.get(currentStudentIndex);
            
            if (currentStudent) {
                document.getElementById('currentStudentIndex').textContent = currentStudent.index;
                document.getElementById('markInput').value = currentStudent.mark || '';
                document.getElementById('currentPosition').textContent = currentStudentIndex + 1;
                document.getElementById('totalStudents').textContent = totalStudents;
                
                // Update navigation buttons
                document.getElementById('prevButton').disabled = currentStudentIndex === 0;
                
                // Update focus to mark input
                setTimeout(() => {
                    document.getElementById('markInput').focus();
                }, 100);
            }
        }

        // Handle mark input keypress
        function handleMarkInputKeypress(event) {
            if (event.key === 'Enter') {
                nextStudent();
            }
        }

        // Move to next student
        function nextStudent() {
            const markInput = document.getElementById('markInput');
            const mark = parseFloat(markInput.value);
            
            if (isNaN(mark) || mark < 0 || mark > 100) {
                showNotification('Please enter a valid mark between 0 and 100', 'error');
                return;
            }
            
            // Update current student in LinkedList
            const currentStudent = studentsLinkedList.get(currentStudentIndex);
            currentStudent.mark = mark;
            currentStudent.isCompleted = true;
            studentsLinkedList.set(currentStudentIndex, currentStudent);
            
            // Move to next student
            if (currentStudentIndex < totalStudents - 1) {
                currentStudentIndex++;
                updateCurrentStudentDisplay();
                updateProgress();
                updateLinkedListTable();
            } else {
                // All students completed
                allMarksEntered = true;
                showSaveSection();
                updateProgress();
                updateLinkedListTable();
            }
        }

        // Move to previous student
        function previousStudent() {
            if (currentStudentIndex > 0) {
                currentStudentIndex--;
                updateCurrentStudentDisplay();
                updateProgress();
            }
        }

        // Update progress display
        function updateProgress() {
            let completedCount = 0;
            for (let i = 0; i < studentsLinkedList.getSize(); i++) {
                const student = studentsLinkedList.get(i);
                if (student.isCompleted) {
                    completedCount++;
                }
            }
            
            const percentage = totalStudents > 0 ? (completedCount / totalStudents) * 100 : 0;
            
            document.getElementById('progressText').textContent = `${completedCount} / ${totalStudents}`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressPercentage').textContent = `${Math.round(percentage)}%`;
        }

        // Update LinkedList table display
        function updateLinkedListTable() {
            const tableBody = document.getElementById('marksTableBody');
            tableBody.innerHTML = '';
            
            const studentsArray = studentsLinkedList.toArray();
            
            studentsArray.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // Apply different styles based on status
                let statusText = 'Pending';
                let statusClass = 'bg-yellow-100 text-yellow-800';
                
                if (student.isCompleted) {
                    row.className = 'completed-student';
                    statusText = 'Completed';
                    statusClass = 'bg-green-100 text-green-800';
                } else if (index === currentStudentIndex) {
                    row.className = 'current-student';
                    statusText = 'Current';
                    statusClass = 'bg-blue-100 text-blue-800';
                } else {
                    row.className = 'pending-student';
                }
                
                const grade = student.mark > 0 ? calculateGrade(student.mark) : '-';
                const gradeClass = student.mark > 0 ? getGradeColor(grade) : 'bg-gray-100 text-gray-500';
                
                row.innerHTML = `
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${student.index}</td>
                    <td class="px-6 py-4 text-sm font-bold text-gray-900">${student.mark || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${gradeClass}">
                            ${grade}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button 
                            onclick="editStudent(${index})"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                            ${!student.isCompleted ? 'disabled' : ''}
                        >
                            Edit
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Show table if it has content
            document.getElementById('marksTableContainer').classList.remove('hidden');
        }

        // LinkedList Table Sorting Functions using Selection Sort

        let originalLinkedListOrder = null;
        let currentSortState = { ascending: true, column: null };

        /**
         * Sort the LinkedList table by marks using Selection Sort algorithm
         */
        function sortLinkedListTable(ascending = true) {
            if (studentsLinkedList.getSize() === 0) {
                showNotification('No data to sort', 'error');
                return;
            }

            // Check if SelectionSort is available
            if (typeof SelectionSort === 'undefined') {
                showNotification('Selection Sort algorithm not loaded. Please refresh the page.', 'error');
                console.error('SelectionSort class is not defined. Make sure the script is loaded correctly.');
                return;
            }

            try {
                // Store original order if not already stored
                if (!originalLinkedListOrder) {
                    originalLinkedListOrder = studentsLinkedList.toArray().map(student => ({...student}));
                }

                // Show sorting notification
                const direction = ascending ? 'ascending' : 'descending';
                showNotification(`Sorting marks in ${direction} order using Selection Sort...`, 'info');

                // Get students array from LinkedList
                const studentsArray = studentsLinkedList.toArray();
                
                // Create objects for sorting with proper mark handling
                const studentsToSort = studentsArray.map((student, index) => {
                    let sortMark;
                    
                    // Handle different mark states properly
                    if (student.mark && student.mark > 0) {
                        sortMark = student.mark;
                    } else {
                        // Put students with no marks at the end regardless of sort direction
                        sortMark = ascending ? 999999 : -999999;
                    }
                    
                    return {
                        ...student,
                        sortMark: sortMark
                    };
                });

                // Record original for statistics
                const originalMarks = studentsToSort.map(s => s.sortMark);
                
                // Use Selection Sort to sort the students
                const sortedStudents = SelectionSort.sortStudentsByMarks(studentsToSort, 'sortMark', ascending);
                
                // Get sorting statistics
                const sortedMarks = sortedStudents.map(s => s.sortMark);
                const stats = SelectionSort.getSortingStats(originalMarks, sortedMarks);
                
                // Update the LinkedList with sorted data
                studentsLinkedList = new DLinkedList();
                sortedStudents.forEach(student => {
                    // Remove the temporary sortMark property
                    const { sortMark, ...originalStudent } = student;
                    studentsLinkedList.add(originalStudent);
                });
                
                // Update current student index to maintain consistency
                updateCurrentStudentIndexAfterSort(sortedStudents);
                
                // Update the display
                updateLinkedListTable();
                updateSortIndicator(ascending);
                
                // Update sort state
                currentSortState = { ascending, column: 'mark' };
                
                // Show completion notification with stats
                showNotification(
                    `Sorted ${sortedStudents.length} students by marks (${stats.comparisons} comparisons, ${stats.swaps} swaps)`, 
                    'success'
                );
                
            } catch (error) {
                console.error('Error sorting LinkedList table:', error);
                showNotification('Error occurred while sorting: ' + error.message, 'error');
            }
        }

        /**
         * Update current student index after sorting to maintain editing context
         */
        function updateCurrentStudentIndexAfterSort(sortedStudents) {
            if (currentStudentIndex >= 0 && currentStudentIndex < sortedStudents.length) {
                const currentStudent = studentsLinkedList.get(currentStudentIndex);
                if (currentStudent) {
                    // Find the new position of the current student
                    const newIndex = sortedStudents.findIndex(student => 
                        student.index === currentStudent.index
                    );
                    if (newIndex !== -1) {
                        currentStudentIndex = newIndex;
                    }
                }
            }
        }

        /**
         * Reset LinkedList table to original order
         */
        function resetLinkedListOrder() {
            if (!originalLinkedListOrder) {
                showNotification('No original order to restore', 'error');
                return;
            }

            try {
                // Restore original LinkedList order
                studentsLinkedList = new DLinkedList();
                originalLinkedListOrder.forEach(student => {
                    studentsLinkedList.add({...student});
                });

                // Find the correct current student index after reset
                currentStudentIndex = 0;
                for (let i = 0; i < studentsLinkedList.getSize(); i++) {
                    const student = studentsLinkedList.get(i);
                    if (!student.isCompleted) {
                        currentStudentIndex = i;
                        break;
                    }
                }

                // Update displays
                updateLinkedListTable();
                updateCurrentStudentDisplay();
                resetSortIndicator();
                
                // Reset sort state
                currentSortState = { ascending: true, column: null };
                
                showNotification('LinkedList order reset to original', 'success');
                
            } catch (error) {
                console.error('Error resetting LinkedList order:', error);
                showNotification('Error occurred while resetting: ' + error.message, 'error');
            }
        }

        /**
         * Update sort indicator in table header
         */
        function updateSortIndicator(ascending) {
            const indicator = document.getElementById('markSortIndicator');
            if (indicator) {
                const iconClass = ascending ? 'fa-sort-up' : 'fa-sort-down';
                const colorClass = ascending ? 'text-green-600' : 'text-orange-600';
                indicator.innerHTML = `<i class="fas ${iconClass} ${colorClass}"></i>`;
            }
        }

        /**
         * Reset sort indicator
         */
        function resetSortIndicator() {
            const indicator = document.getElementById('markSortIndicator');
            if (indicator) {
                indicator.innerHTML = '<i class="fas fa-sort"></i>';
            }
        }

        /**
         * Toggle sort direction when clicking on mark header
         */
        function toggleMarkSort() {
            if (studentsLinkedList.getSize() === 0) {
                showNotification('No data to sort', 'error');
                return;
            }

            const indicator = document.getElementById('markSortIndicator');
            if (!indicator) return;

            const currentIcon = indicator.querySelector('i');
            let ascending;

            if (currentIcon.classList.contains('fa-sort')) {
                // Currently unsorted, sort ascending
                ascending = true;
            } else if (currentIcon.classList.contains('fa-sort-up')) {
                // Currently sorted ascending, switch to descending
                ascending = false;
            } else if (currentIcon.classList.contains('fa-sort-down')) {
                // Currently sorted descending, reset to original order
                resetLinkedListOrder();
                return;
            } else {
                // Default case
                ascending = true;
            }

            // Perform the sort
            sortLinkedListTable(ascending);
        }

        // Edit specific student
        function editStudent(index) {
            currentStudentIndex = index;
            allMarksEntered = false;
            
            // Hide save section and show mark entry
            document.getElementById('saveSection').classList.add('hidden');
            document.getElementById('markEntrySection').classList.remove('hidden');
            
            updateCurrentStudentDisplay();
            updateLinkedListTable();
        }

        // Calculate grade based on mark
        function calculateGrade(mark) {
            if (mark >= 90) return 'A+';
            if (mark >= 85) return 'A';
            if (mark >= 80) return 'A-';
            if (mark >= 75) return 'B+';
            if (mark >= 70) return 'B';
            if (mark >= 65) return 'B-';
            if (mark >= 60) return 'C+';
            if (mark >= 55) return 'C';
            if (mark >= 50) return 'C-';
            return 'F';
        }

        // Get grade color class
        function getGradeColor(grade) {
            if (grade.startsWith('A')) return 'bg-green-100 text-green-800';
            if (grade.startsWith('B')) return 'bg-blue-100 text-blue-800';
            if (grade.startsWith('C')) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        // Save all marks to database
        async function saveAllMarks() {
            try {
                document.getElementById('saveButton').disabled = true;
                document.getElementById('saveButton').textContent = 'Saving...';
                
                const marksArray = studentsLinkedList.toArray();
                
                const requestData = {
                    marksData: marksArray,
                    filters: sessionParams
                };
                
                const response = await fetch('/api/marks/save-bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('Marks saved successfully!', 'success');
                    showNotification(`Saved ${result.saved_count} student marks to database`, 'info');
                    // Optionally redirect back to summary page
                    setTimeout(() => {
                        goBack();
                    }, 3000);
                } else {
                    showNotification('Failed to save marks: ' + result.error, 'error');
                    console.error('Save error details:', result);
                }
                
            } catch (error) {
                console.error('Error saving marks:', error);
                showNotification('Network error while saving marks: ' + error.message, 'error');
            } finally {
                document.getElementById('saveButton').disabled = false;
                document.getElementById('saveButton').textContent = 'Save All Marks to Database';
            }
        }

        // Review marks (go back to editing)
        function reviewMarks() {
            currentStudentIndex = 0;
            allMarksEntered = false;
            
            document.getElementById('saveSection').classList.add('hidden');
            document.getElementById('markEntrySection').classList.remove('hidden');
            
            updateCurrentStudentDisplay();
            updateLinkedListTable();
        }

        // State management functions
        function showLoadingState() {
            hideAllStates();
            document.getElementById('loadingState').classList.remove('hidden');
        }

        function showError(message) {
            hideAllStates();
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').classList.remove('hidden');
        }

        function showMarkEntrySection() {
            hideAllStates();
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('markEntrySection').classList.remove('hidden');
        }

        function showSaveSection() {
            document.getElementById('markEntrySection').classList.add('hidden');
            document.getElementById('saveSection').classList.remove('hidden');
        }

        function hideAllStates() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('markEntrySection').classList.add('hidden');
            document.getElementById('saveSection').classList.add('hidden');
        }

        // Go back to summary page
        function goBack() {
            window.location.href = '/summary';
        }

        // Redirect to homepage
        function goHome() {
            window.location.href = '/';
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            else if (type === 'error') bgColor = 'bg-red-500';
            
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${bgColor}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Verify SelectionSort is loaded
            if (typeof SelectionSort !== 'undefined') {
                console.log('✅ SelectionSort class loaded successfully');
            } else {
                console.error('❌ SelectionSort class not found');
                showNotification('Sorting functionality unavailable - please refresh the page', 'error');
            }
            
            parseUrlParameters();
            loadStudentsData();
        });
    </script>
</body>
</html>